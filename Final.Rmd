---
title: "FIFA18"
author: "Kesong Wu"
date: "2018/4/29"
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(rworldmap)
```

##Introduction

We will use the statistical information of football plyers inthe video game FIFA 18.

##Load the data and Clean the data
There are three tables we may use in this project.
```{r load, echo=FALSE}
ppd <- read.csv("PlayerPersonalData.csv", header = TRUE)
# Player's Personal Data
ppp <- read.csv("PlayerPlayingPositionData.csv", header = TRUE)
# Player's Playing Position Data
pad <- read.csv("PlayerAttributeData.csv", header = TRUE)
# Player's Attribute Data
```

Let's have a glimpse on the data.
```{r glimpse, echo=FALSE}
glimpse(ppd)
glimpse(ppp)
glimpse(pad)
```

From the glimpse we can find that every table has useless columns and there is a column called "index" that can join the three tables together.
```{r join, echo=FALSE}
fifa <- ppd[,-c(1:2)] %>%
  full_join(ppp[,-1], by = "ID") %>%
  full_join(pad[,-1], by = "ID")

kable(head(fifa))
```

##Ages of football players

Let's have a look at the density of the ages of these football player.
```{r ages, echo=FALSE}
ggplot(fifa, aes(Age)) + geom_density()
```

From this plot we can see that most players are between 18 and 30.

##Player's Overall

Let's see how the overall scores of all the players are distribute.
```{r overall, echo=FALSE}
fifa %>%
  ggplot(aes(x = Overall, fill = factor(Overall))) + geom_bar() + ggtitle("Player's Overall") + theme(plot.title = element_text(hjust = .5)) + guides(fill = FALSE)
# Use guides(fill = FALSE) to avoid messing up the plot
```

Then let's see if overall scores are related to players' ages.
```{r ova, echo=FALSE}
fifa %>%
  ggplot(aes(x = Age, y = Overall)) + geom_point() + geom_smooth(span = 1) 
```

We can see that the players are improving with the step of the years. The best players are 30 years old and after that they start to decline.

##Best Players & Clubs
Based on the overall score, we will find which are the best ten players.
```{r bestplayer, echo=FALSE}
fifa %>%
  arrange(desc(Overall)) %>%
  select(Name, Overall, Club) %>%
  head(10)
```

Then, let's have a look at each team's best player's overall, worst player's overall and the average overall.
```{r teamplayer, echo=FALSE}
TeamPower <- fifa %>%
  select(Name, Club, Overall) %>%
  group_by(Club) %>%
  summarise(Best = max(Overall), Worst = min(Overall), Ave = mean(Overall)) %>%
  arrange(desc(Ave))

TeamPower
```

We can see that the best three clubs are FC Barcelona, Juventus and Real Madrid CF.

##Players who earned most and Clubs paid most
```{r wage, echo=FALSE}
fifa$Wage <- gsub("€", "", fifa$Wage)
fifa$Wage <- gsub("K", "e+03", fifa$Wage)
fifa$Wage <- as.numeric(fifa$Wage)

fifa %>%
  select(Name, Wage, Club) %>%
  arrange(desc(Wage)) %>%
  head(10)
```

We can see that, C.Ronaldo and Messi earned most.
```{r teamwage, echo=FALSE}
TeamWage <- fifa %>%
  select(Name, Wage, Club) %>%
  group_by(Club) %>%
  summarise(TotalWage = sum(Wage)) %>%
  arrange(desc(TotalWage))

TeamWage
```
We can see that FC Barcelona, Real Madrid CF and Manchester United paid most.

Let's combine this result with the best teams result we studied before.
```{r pvw, echo=FALSE, warning=FALSE}
TeamPower %>%
  full_join(TeamWage, by = "Club") %>%
  ggplot(aes(x = TotalWage, y = Ave)) + geom_point() + geom_smooth()
```

From this plot, we can easily see that, to be a better team, you have to pay more money.

##Players' Value

We can see that many players might sign a cheap contract before, we now study there value. ^We can use sciece notation here.^
```{r playervalue, echo=FALSE}
fifa$Value <- gsub("€", "",fifa$Value)
fifa$Value <- gsub("M", "e+06",fifa$Value)
fifa$Value <- gsub("K", "e+03",fifa$Value)
fifa$Value <- as.numeric(fifa$Value)

fifa %>%
  select(Name, Club, Value) %>%
  arrange(desc(Value)) %>%
  head(10)
```
We can see Neymar valued most instead of C.Ronaldo and Messi.

Our table seems better now, and we can output a new csv file for future use.
```{r output, echo=TRUE}
write.csv(fifa, file = "FIFA18.csv")
```

##Nationalities of the Players

Here we use a new package called "rWorldMap" to show the players' nationalitites in a world map.
```{r worldmap, echo=FALSE}
nation <- fifa %>%
  group_by(Nationality) %>%
  summarise(n = n())

prepare <- joinCountryData2Map(dF = nation, joinCode = "NAME", nameJoinColumn = "Nationality", verbose = FALSE)

mapCountryData(mapToPlot = prepare, nameColumnToPlot = "n", catMethod = "fixedWidth",
               oceanCol = "steelblue1", missingCountryCol = "white", 
               mapTitle = "Number of Players by Country", aspect = "variable")
```

We can see that China has no players in these clubs, European countries and South American countries have the most players.
```{r nation, echo=FALSE}
nation %>%
  arrange(desc(n)) %>%
  head(10)
```
These are the countries have most players.